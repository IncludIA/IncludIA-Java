trigger:
  - main

variables:
  # --- Suas Variáveis ---
  azureSubscription: 'azureSubscription'
  acrConnection: 'acrConnection'
  acrLoginServer: 'acrincludia2771.azurecr.io'
  webAppName: 'app-includia-java-2771'
  imageRepository: 'includia-java-api'
  
  # CAMINHO DA PASTA: Ajuste se necessário. 
  # Deve ser o nome da pasta onde está o 'dockerfile' no seu Git.
  javaRootPath: 'IncludIA-Java' 
  dockerfilePath: '$(javaRootPath)/dockerfile'
  
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
  # ------------------------------------------------------------------
  # ESTÁGIO 1: BUILD (Cria a Imagem que falta)
  # ------------------------------------------------------------------
  - stage: Build
    displayName: Build and Push Stage
    jobs:
      - job: Build
        displayName: Build Job
        pool:
          vmImage: $(vmImageName)
        steps:
          # Configura Java
          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
            displayName: 'Setup Java 21'

          # Permissão para gradlew
          - script: chmod +x $(javaRootPath)/gradlew
            displayName: 'Grant execute permission to gradlew'

          # Compila e Testa (Gera o .jar)
          - task: Gradle@3
            displayName: 'Build and Test Java'
            inputs:
              workingDirectory: '$(javaRootPath)'
              gradleWrapperFile: '$(javaRootPath)/gradlew'
              tasks: 'build' # Roda build completo
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17' # Compatibilidade Gradle
              sonarQubeRunAnalysis: false 

          # Cria e Envia a Imagem Docker (Resolve o erro "Manifest not found")
          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(acrConnection)
              buildContext: '$(javaRootPath)'
              tags: |
                $(tag)
                latest

  # ------------------------------------------------------------------
  # ESTÁGIO 2: DEPLOY (Agora vai funcionar pois a imagem existirá)
  # ------------------------------------------------------------------
  - stage: Deploy
    displayName: Deploy Stage
    dependsOn: Build    # Espera o Build terminar
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: Deploy to Azure Web App
        environment: 'production'
        pool:
          vmImage: $(vmImageName)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  displayName: 'Azure Web App Deploy'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appName: $(webAppName)
                    containers: $(acrLoginServer)/$(imageRepository):$(tag)
                    appSettings: |
                      -SPRING_PROFILES_ACTIVE "prod"
                      -PORT 80