# 游 Pipeline de CI para Includ.IA (Backend Java/Spring Boot)
# Stack: Java 21, Gradle, Docker, Azure Container Registry

trigger:
  - azure-pipelines

pool:
  vmImage: 'ubuntu-latest' # Agente Linux

variables:
  dockerRegistryServiceConnection: 'AcrConnection'
  
  azureSubscription: 'azureSubscription'
  acrConnection: 'acrConnection' 
  imageRepository: 'includia-java-api'
  dockerfilePath: '$(Build.SourcesDirectory)/dockerfile'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build & Test Stage
  jobs:
  - job: Build
    displayName: Build, Test and Push
    steps:

    # 1. Configurar Java 21 (Essencial, pois o padr칚o pode ser 11 ou 17)
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '21'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
      displayName: 'Setup Java 21'

    # 2. Dar permiss칚o de execu칞칚o ao Gradlew (Comum dar erro em Linux se esquecer)
    - task: Bash@3
      displayName: 'Chmod Gradlew'
      inputs:
        targetType: 'inline'
        script: 'chmod +x gradlew'

    # 3. Rodar Testes Unit치rios e Publicar Resultados (Requisito de QA/DevOps)
    # Isso gera os gr치ficos de teste no Azure DevOps
    - task: Gradle@3
      displayName: 'Run Unit Tests'
      inputs:
        workingDirectory: ''
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.21'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/TEST-*.xml'
        tasks: 'test'

    # 4. Construir e Enviar Imagem Docker para o ACR
    # O seu Dockerfile j치 faz o build do JAR (Multistage), ent칚o s칩 mandamos buildar a imagem
    - task: Docker@2
      displayName: 'Build and Push Docker Image'
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    # 5. Copiar Scripts de Infra para o Artefato
    # Necess치rio para a Pipeline de Release (CD) saber onde implantar
    - task: CopyFiles@2
      displayName: 'Copy Scripts to Artifact'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/scripts' # Certifique-se que a pasta chama 'scripts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/scripts'

    # 6. Publicar Artefatos (Drop)
    # Gatilho para a Pipeline de Release iniciar
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'